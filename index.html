<!DOCTYPE html>
<html>
 <head>
     <link rel="stylesheet" href="vis.css">
     <meta charset="utf-8">
     <script src="https://d3js.org/d3.v4.min.js"></script>
     <script src="setOps.js"></script>
     <script src="//vk.com/js/api/openapi.js" type="text/javascript"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.16.1/vis.min.js"></script>
     <script type="text/javascript" src="jLouvain.js"></script>
     <style type="text/css">
            #mynetwork {
              width: 800px;
              height: 800px;
              border: 1px solid lightgray;
            }
  </style>
 </head>
 
 <div id="right" ></div>
 <div id="left"> 
  <body>
    <center>
    <!-- <canvas width="1000" height="1000"></canvas> -->
    <div id="mynetwork"></div>
    <h1>The VK visualizer</h1>
    <p>Enter An ID number</p>
    <input id="vkId" value="218868103">
    <button type="button" onclick="fetchDetails()">Get Info</button>
    <button type="button" onclick="fetchFriendList()">get friends</button>
    <button type="button" onclick="launch_graph()">Build Graph</button>
    <button type="button" onclick="test_button()">Launch!</button>
    <p>Who is this person?</p>
    <img id="current_contact" src="" alt='picture'>
    <p id="friendDetails">let's find out</p>
    <p>Who are the friends?</p>
    <p id="friendList"></p>
    <p id="testBox">Test</p>

    </center>
  </body>
  </div>
  

  <script>
// https://wyler-m.github.io/vk-net/#access_token=404fa1c22ba9ba03d1b0f23912316fb7032d1090b648165672555b8cf174bd3fe9249c924cbe8ffc0662a&expires_in=86400&user_id=218868103
//script.src = "https://api.vk.com/method/getProfiles?uid=218868103&callback=callbackFunc";
//script.src = 'https://api.vk.com/method/friends.get?uid=218868103&callback=callbackFunc';
//script.src = 'https://api.vk.com/method/users.get?uids=218868103&lang=en&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town&callback=callbackFunc'

// http://visjs.org/examples/network/exampleApplications/worldCupPerformance.html
// http://www.almende.com/contact
var so = setOps;
window.launch = false;
window.friends = null;
window.unCheckedFriends = null;
window.addedFriends = null;
window.graph = {"nodes":[],"links":[]};
window.currentNode = null;

// window.urlParams = parseURLParams();

// console.log(parseURLParams());
// console.log(window.urlParams);

function parseURLParams() {
    var params = {};
    var param_array = window.location.href.split('#')[1].split('&');
    for(var i in param_array){
        x = param_array[i].split('=');
        params[x[0]] = x[1];
    }
    return params;
}

// var url = 'https://api.vk.com/method/users.get?uids='.concat(window.urlParams.user_id,'&lang=en&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town,photo_200&callback=api_FetchDetails').concat(window.urlParams.access_token);


function test_button(){  

make_node_list();
redrawAll();
}
 
function fetchDetails() {
    var x;
    x = document.getElementById("vkId").value;
    var script = document.createElement('SCRIPT');
    script.src = 'https://api.vk.com/method/users.get?uids='.concat(x,'&lang=en&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town,photo_200&callback=api_FetchDetails');   
    document.getElementsByTagName("head")[0].appendChild(script);
    }

function fetchFriendList(id) {
    if (!id) {
      var x;
      x = document.getElementById("vkId").value;
      window.currentNode = document.getElementById("vkId").value;
    } else {x = id; window.currentNode = id;};

    var script = document.createElement('SCRIPT');
    script.src = 'https://api.vk.com/method/friends.get?uid='.concat(x,'&callback=api_FetchFriendList');
    document.getElementsByTagName("head")[0].appendChild(script);
    }

function api_FetchDetails(result) {
    document.getElementById("friendDetails").innerHTML = JSON.stringify(result);
    document.getElementById("testBox").innerHTML = result["response"][0]["first_name"];
    document.getElementById("current_contact").src = result["response"][0]["photo_200"];
}

function api_FetchFriendList(result) {
    //check to see if there are any friends
    if (!window.friends) { 
      
      window.unCheckedFriends = result["response"];
      window.friends = result["response"].slice(0);
      window.currentNode = window.unCheckedFriends.pop();
      fetchFriendList(window.currentNode);
    } 
//if not, then take intersection of the response and the friends
    else {
    document.getElementById("friendList").innerHTML = Math.floor((1 - window.unCheckedFriends.length / window.friends.length) * 100);

      if (result["response"] && window.friends) {
      var newLinks = so.intersection(window.friends,result["response"]);
      for (var i = newLinks.length - 1; i >= 0; i--) {
          make_link(newLinks[i],window.currentNode);
        };
    };
      
//keep recursing until all the unchecked friends are finished
      if (window.unCheckedFriends.length != 0) {
        window.currentNode = window.unCheckedFriends.pop();
        fetchFriendList(window.currentNode);  
      } else {return};
    }
  //lanch when done
}

function make_link(source,target){
  window.graph.links.push({"from":source,"to":target})
}

function make_node_list(){

  var nodes = window.friends;
        console.log(nodes);

  for (var i = nodes.length - 1; i >= 0; i--) {
    nodes[i] = {"id": nodes[i] ,  "label": 'Yuto Nagatomo', "title": 'Country: ' + 'Japan' + '<br>' + 'Team: ' + 'Internazionale', "value": 29, "group": 27};
  };
  window.graph.nodes = nodes;
}

var network;


function redrawAll() {

    // remove positoins
    // for (var i = 0; i < nodes.length; i++) {
    //   delete nodes[i].x;
    //   delete nodes[i].y;
    // }

    // create a network
    var container = document.getElementById('mynetwork');
    var data = {
      nodes: window.graph.nodes,
      edges: window.graph.links
    };
  console.log(data);
  console.log(window.graph.nodes);

    var options = {
      nodes: {
        shape: 'dot',
        scaling: {
          min: 10,
          max: 30
        },
        font: {
          size: 12,
          face: 'Tahoma'
        }
      },
      edges: {
        width: 0.15,
        color: {inherit: 'from'},
        smooth: {
          type: 'continuous'
        }
      },
      physics: {
        stabilization: false,
        barnesHut: {
          gravitationalConstant: -8,
          springConstant: 0.001,
          springLength: 200
        }
      },
      interaction: {
        tooltipDelay: 200,
        hideEdgesOnDrag: true
      }
    };

    // Note: data is coming from ./datasources/WorldCup2014.js
    network = new vis.Network(container, data, options);
  }


// function launch_graph(){

//  make_node_list();

//   //draw canvas
// var canvas = document.querySelector("canvas"),
//     context = canvas.getContext("2d"),
//     width = canvas.width,
//     height = canvas.height;

// //build simulation
// var simulation = d3.forceSimulation()
//     .force("link", d3.forceLink().id(function(d) { return d.id; }))
//     .force("charge", d3.forceManyBody())
//     .force("center", d3.forceCenter(width / 2, height / 3 * 2));
// d3.select()

// //build graph
// d3.json(null, function(error, graph1) {
// console.log(window.graph);

//   simulation
//       .nodes(window.graph.nodes)
//       .on("tick", ticked);

//   simulation.force("link")
//       .links(window.graph.links);

//   d3.select(canvas)
//       .call(d3.drag()
//           .container(canvas)
//           .subject(dragsubject)
//           .on("start", dragstarted)
//           .on("drag", dragged)
//           .on("end", dragended));

//   function ticked() {
//     context.clearRect(0, 0, width, height);

//     context.beginPath();
//     window.graph.links.forEach(drawLink);
//     context.strokeStyle = "#aaa";
//     context.stroke();

//     context.beginPath();
//     window.graph.nodes.forEach(drawNode);
//     context.fill();
//     context.strokeStyle = "#fff";
//     context.stroke();
//   }

//   function dragsubject() {
//     return simulation.find(d3.event.x, d3.event.y);
//   }
// });

// function dragstarted() {
//   if (!d3.event.active) simulation.alphaTarget(0.3).restart();
//   d3.event.subject.fx = d3.event.subject.x;
//   d3.event.subject.fy = d3.event.subject.y;
// }

// function dragged() {
//   d3.event.subject.fx = d3.event.x;
//   d3.event.subject.fy = d3.event.y;
// }

// function dragended() {
//   if (!d3.event.active) simulation.alphaTarget(0);
//   d3.event.subject.fx = null;
//   d3.event.subject.fy = null;
// }

// function drawLink(d) {
//   context.moveTo(d.source.x, d.source.y);
//   context.lineTo(d.target.x, d.target.y);
// }

// function drawNode(d) {
//   context.moveTo(d.x + 3, d.y);
//   context.arc(d.x, d.y, 3, 0, 2 * Math.PI);
// }
// }



</script>

</html> 
