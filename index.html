<!DOCTYPE html>
<html>
	<head>
		<title>VK Visualizer</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="css/vis.css">
		<link rel="stylesheet" href="css/w3.css">
    <script type="text/javascript" src="lib/setOps.js"></script>
    <script type="text/javascript" src="lib/cb.js"></script>
		<script type="text/javascript" src="lib/vis.js"></script>
    <script type="text/javascript" src="lib/buttonControl.js"></script>
    <script type="text/javascript" src="lib/apiCalls.js"></script>
		<script type="text/javascript" src="classes/poster.js"></script>
		<script type="text/javascript" src="classes/graphClass.js"></script>
		<script type="text/javascript" src="tests/test_data.js"></script>
	</head>
<body>

<menu id = "controlDiv" >
<div id = "hideDiv" >
  <h1 id="logo"><img src= "img/vk.svg"> visualizer</h1>
  <h4 id="foundName"></h4>
  <input id="vkId" class="w3-input w3-border w3-hover-blue" value="180440651"></p>
  <a id="buildGraphButton" class="w3-btn-block w3-hover-blue w3-border w3-border-blue w3-white" onclick="build_graph()">Строй График</a>
    <button onclick="collaps_control('Demo1')" class="w3-btn-block w3-hover-blue w3-border w3-border-blue w3-white">Node Size</button>
    <div id="Demo1" class="w3-accordion-content">
        <button class="w3-btn-block w3-hover-blue w3-border w3-border-red w3-white" style="width:90%" onclick='change_node_size("degree","")'>Friends</button></br>
        <button class="w3-btn-block w3-hover-blue w3-border w3-border-red w3-white" style="width:90%" onclick="change_weights_p()">Friends^2</button></br>
        <button class="w3-btn-block w3-hover-blue w3-border w3-border-red w3-white" style="width:90%" onclick="change_weights_ap()">"popularity"</button></br>
        <button class="w3-btn-block w3-hover-blue w3-border w3-border-red w3-white" style="width:90%" onclick="change_weights_centrality()">centrality</button></br>
        <button id ="receivedLikes" class="w3-btn-block w3-hover-blue w3-border w3-border-red w3-white" style="width:90%" onclick="change_weights_received()">received likes</button></br>
        <button id ="givenLikes" class="w3-btn-block w3-hover-blue w3-border w3-border-red w3-white" style="width:90%" onclick="change_weights_given()">given likes</button></br>
        <button id="calcLikes" class="w3-btn-block w3-hover-blue w3-border w3-border-red w3-white" style="width:90%" onclick="constuct_like_dict()">calc likes</button></br>
        <div class="w3-progress-container w3-round w3-large w3-round" id="likesProgbarContainer" hidden>
          <div class="w3-progressbar w3-round w3-red w3-text-black" id="likesProgbar" style="width:0%"></div>
        </div>
    </div>

  <button class="w3-btn-block w3-hover-blue w3-border w3-border-blue w3-white" onclick="showNodesCB()" id="toggleLabels">Show Labels</button>
</div>
<br>
<button href="javascript:void(0)" onclick="w3_close()" id="closeMenu" class="w3-btn w3-small w3-round-xxlarge w3-hover-blue w3-border w3-border-blue w3-white"><</button>
  <button href="javascript:void(0)" onclick="w3_open()" id="openMenu"  class="w3-btn w3-small w3-round-xxlarge w3-hover-blue w3-border w3-border-blue w3-white">></button>
</menu>

<div id="container" >
<div id="nodeInfo" >
  <center  >
  
  <img id="selectedPic" class="w3-btn-block" src = ''>
  <a id="selectedName" class="w3-btn-block w3-hover-blue w3-border w3-border-blue w3-white" target="_blank" href="#">name</a>
  <a id="selectedImportance"class="w3-btn-block w3-white w3-border w3-border-blue">importance</p>
  <a id="selectedDegree"class="w3-btn-block w3-white w3-border w3-border-blue">0</a>
<!-- <a id="selectedProfile" class="w3-btn-block w3-hover-blue w3-bottombar w3-border-blue" target="_blank" class="mylink" href="https">Visit Profile</a> -->
  <a id="buildSelected" class="w3-btn-block w3-hover-blue w3-white w3-border w3-border-blue"target="_blank" href="https">Строй График</a>
</center>
</div>

<div class="w3-display-container" id="test"> 
      <div class="w3-card-4 w3-display-bottommiddle">
        <button class="w3-btn-block w3-hover-blue w3-red" onclick="freeze_graph()" id="freezeGraph" style="display:none;">Click to Freeze</button>
      </div>

      <div class="w3-card-4 w3-display-middle w3-white w3-border w3-border-blue w3-round-xlarge" style="display:none;z-index:1" id="graphingCard">
               <header class="w3-container">
                 <h5 id="welcome"></h5>
               </header>
               <div class="w3-container" id="progressContainer">
                 <div class="w3-progress-container w3-round w3-large ">
                   <div class="w3-progressbar w3-round w3-blue" id="progbar" style="width:0%"></div>
                 </div>
               <footer class="w3-container">
                 <h5 id="friendList"></h5>
             </footer>
               </div>
       </div>
       <div class="w3-card-4 w3-display-middle w3-white w3-border w3-border-blue w3-round-xlarge" style="display:block;z-index:1;padding:10px" id="searchCard">
        <div id="searchDiv" hidden>
               <header class="w3-container">
                 <!-- <h4 id="foundNameCenter">Напиши Кличку</h4> -->
                 <h4 id="foundNameCenter">Считать Карту Моих Друзей!</h4>
               </header>
               <div class="w3-container" id="search"></div>
               <!-- <input id="searchBox" class="w3-input w3-border w3-hover-blue" value="" oninput="get_posts()"></p> -->
               <button class="w3-btn-block w3-hover-blue w3-border w3-border-blue w3-white" onclick="build_graph()">Строй График</button></br>
               <footer class="w3-container">
                 <h5 id="friendList"> </h5>
             </footer>
        </div>
        <div id="loginDiv">
            <a class="w3-btn-block w3-hover-blue w3-border w3-border-blue w3-white" id="loginP" href="https://oauth.vk.com/authorize?client_id=4966960&display=page&redirect_uri=https://wyler-m.github.io/vk-net/&scope=friends&response_type=token&v=5.60" >Войти на VK.com</a>      
        </div>
      </div>
    <div id="mynetwork" class="wrapper" hidden></div>
  </div>
</div>
<div id="data" class="wrapper"></div>

<a href="" id="download" target="_blank" download="graph.html">Save Image</a>
<button type="button" onclick="canvas_image()">get image</button>
<button type="button" onclick="save_build()">save build</button>
<button type="button" style="margin-right:200px" onclick="test_build()">test build</button>

</body>

<script>

$("#openMenu").hide();

so = setOps;
access_token = null;

params = parseURLParams();
graph_dict = {}

if (params) {
  for (var param in params) {
     if (param == "user_id") {
        document.getElementById("vkId").value = params.user_id; 
      };
      if (param == "access_token"){
        $("#loginP").hide();  
        $("#searchDiv").show(); 
        $("#calcLikes").show();
        access_token = params.access_token;
      }
   }; 
};

w3_close()
$("#loginDiv").show();
$("#nodeInfo").hide();
$("#givenLikes").hide();
$("#receivedLikes").hide();
$("#buildSelected").hide();
$("#calcLikes").hide();


$("#selectedName").click(function(){
    ga_onclick("#selectedName","Check Profile");
});

$("#buildSelected").click(function(){
    ga_onclick("#buildSelected","Строй График");
});


function build_graph(test){
  $("#searchCard").hide();
	$("#mynetwork").hide();
	$("#nodeInfo").hide();
	$("#graphingCard").show()	
	$("#graphingCard").attr("class","w3-card-4 w3-display-middle w3-white w3-border w3-border-blue w3-round-xlarge");
	$("#progressContainer").show();
	
	cur_graph = new graph;
  
		
    options = {
      nodes: {
        shape: 'dot',
        scaling: {
          min: 3,
          max: 30
        },
        font: {
          size: 0,
          face: 'Tahoma'
        }
      },
      edges: {
        width: 0.15,
        color: {inherit: 'from'},
        smooth: {
          type: 'continuous'
        }
      },
      physics: {
        stabilization: {
          iterations:100
        },
        adaptiveTimestep: true,
        timestep: .5,
        // forceAtlas2Based: {
        // barnesHut: {
          repulsion:{
          centralGravity: -80000,
          damping: 0.4,
          springConstant: 2,
          springLength: 10,
        }
      },

      interaction: {
        tooltipDelay: 10,
        hideEdgesOnDrag: true
      }
    };
    data_set = new vis.DataSet(options);

	if (!test) {fetchFriendList()};
	};

function ga_onclick(element,action){
      ga( 'send', 'event', {
          'eventCategory': 'link out',
          'eventAction': action,
          'eventLabel': $(element).attr("href")
        }); 
  }

function insertNodeInfo (argument) {
  var nodeInfo = data_set.get(argument.nodes[0])
  if (cur_graph.nodeToFriends[nodeInfo.id]) {
    var total_friends = cur_graph.nodeToFriends[argument.nodes[0]].length;
  }else {var total_friends = 0
  };
  $("#nodeInfo").toggle();
  // $("#controlDiv").toggle();

  $("#selectedName").text(nodeInfo.label);
  $("#foundName").text(nodeInfo.label);

  $("#toolTipName").attr("innerHTML","nodeInfo.label");
  $("#selectedPic").attr("src",nodeInfo.small_pic);

  $("#selectedImportance").text("Average Rank: " + nodeInfo.value);
  document.getElementById("vkId").value = nodeInfo.id;

  if (nodeInfo.id in cur_graph.weightsDictionary.degree) {
    $("#selectedDegree").text("Connections: " + cur_graph.weightsDictionary.degree[nodeInfo.id]);
  } else {$("#selectedDegree").text("no connections")};
  
  $("#selectedName").attr("href","https://www.vk.com/id"+nodeInfo.id);


  if (nodeInfo.id && (nodeInfo.small_pic!="https://vk.com/images/deactivated_100.png")){
    $("#buildSelected").text("Строй График ("+ total_friends + " friends)");
    $("#buildGraphButton").text("Строй График ("+ total_friends + " friends)");
    $("#buildSelected").attr("href","https://wyler-m.github.io/vk-net#user_id="+nodeInfo.id);
    $("#buildSelected").show();

  } else {$("#buildSelected").hide();};
// google analytics
      ga( 'send', 'event', {
          'eventCategory': 'graph interaction',
          'eventAction': 'select node',
          'eventLabel': nodeInfo.id
        }); 
};

function parseURLParams() {
    var params = {};
    var args = window.location.href.split('#');
    if (args[1]) {
      var param_array = args[1].split('&');
      for(var i in param_array){
          x = param_array[i].split('=');
          params[x[0]] = x[1];
      }
    };
    return params;
}

function update_progress(total_v, current_v){
    document.getElementById("friendList").innerHTML = "Added "+ (total_v - current_v) +" of " + total_v + " friends";
    var progbar = document.getElementById("progbar")
    var percent = (total_v - current_v)/total_v *100;
    progbar.style.width = percent +'%';
}


function freeze_graph(){  
  if (network) {
    network.stopSimulation();
          ga( 'send', 'event', {
          'eventCategory': 'graph interaction',
          'eventAction': 'freeze graph',
          'eventLabel': cur_graph.ownerInfo["id"],
          'eventValue': cur_graph.get_density()
        }); 
  };
}
 
function constuct_like_dict(){
  $("#likesProgbarContainer").show();
  var likes_dict = {"received":{},"given":{}};
  var update = update_progress;
  build_like_dictionary(likes_dict,cur_graph,update,access_token);
  cur_graph.weightsDictionary["given"] = likes_dict["given"];
  cur_graph.weightsDictionary["received"] = likes_dict["received"];
  $("#calcLikes").hide();
}

function showNodesCB(){
  options.nodes.font.size = (options.nodes.font.size == 0) ? 14 : 0 
  var text = $("#toggleLabels").text();
  $("#toggleLabels").text(text == "Show Labels" ? "Hide Labels" :"Show Labels");
  network.setOptions(options);
  network.redraw();
  network.stopSimulation();
 };


function change_weights_p(){
  cur_graph.normalize_weights("quad","degree",false);
  cur_graph.set_weights("quad degree",data_set);
  network.redraw();
  network.stopSimulation()

    ga( 'send', 'event', {
          'eventCategory': 'change weight',
          'eventAction': 'popularity'
        }); 
}

function change_weights_ap(){
  cur_graph.normalize_weights("linear","popularityDeg",false);
  cur_graph.set_weights("linear popularityDeg",data_set);
  network.redraw();
  network.stopSimulation()
}

function change_weights_centrality(){
  if (!("centrality" in cur_graph.weightsDictionary)) {
    cur_graph.weightsDictionary["centrality"] = get_centrality(cur_graph,network);
  };
  cur_graph.set_weights("centrality",data_set);
  network.redraw();
  network.stopSimulation()

      ga( 'send', 'event', {
          'eventCategory': 'change weight',
          'eventAction': 'average popularity'
        }); 
}

function change_node_size(weight_type,normilization){
  //normilzation can be linear, quad, or log
  //weight_type is the name of the weight dictionary being used
  if (normilization) {
    cur_graph.normalize_weights(normilization,weight_type);
    cur_graph.set_weights(normilization+" "+weight_type,data_set);
  }else{
    cur_graph.set_weights(weight_type,data_set)
  };
  network.redraw();
  network.stopSimulation()
}

function change_weights_received(){
  cur_graph.set_weights("received",data_set);
  network.redraw();
  network.stopSimulation()
}

function change_weights_given(){
  cur_graph.set_weights("given",data_set);
  network.redraw();
  network.stopSimulation()
}

function test_build(){
  build_graph(true);
  cur_graph.currentNode = test_data.currentNode  
  cur_graph.edges = test_data.edges   
  cur_graph.first_pass = test_data.first_pass   
  cur_graph.friends = test_data.friends   
  cur_graph.nodeToFriends = test_data.nodeToFriends  
  cur_graph.nodeToInfo = test_data.nodeToInfo   
  cur_graph.nodes = test_data.nodes   
  cur_graph.nodesRetrieved = test_data.nodesRetrieved   
  cur_graph.ownerInfo = test_data.ownerInfo   
  cur_graph.unCheckedFriends = test_data.unCheckedFriends   
  cur_graph.weightsDictionary = test_data.weightsDictionary  
  redrawAll()
  change_weights_centrality();
}

function save_build(){
    test_data = {
    "currentNode" : cur_graph.currentNode,  
    "nodeToNeighbors" : cur_graph.nodeToNeighbors,
    "edges" : cur_graph.edges,   
    "first_pass" : cur_graph.first_pass,   
    "friends" : cur_graph.friends,   
    "nodeToFriends" : cur_graph.nodeToFriends,  
    "nodeToInfo" : cur_graph.nodeToInfo,   
    "nodes" : cur_graph.nodes,   
    "nodesRetrieved" : cur_graph.nodesRetrieved,   
    "ownerInfo" : cur_graph.ownerInfo,   
    "unCheckedFriends" : cur_graph.unCheckedFriends,   
    "weightsDictionary" : cur_graph.weightsDictionary 
    }
    document.getElementById("data").innerHTML = JSON.stringify(test_data);

}

function hide_unhide_selected(selected,hide){

  var nodes_to_hide = selected.map(function(x){
   return {"id":x,"hidden":hide}})
  data_set.update(nodes_to_hide)
}


function canvas_image(){
  var canvas = document.getElementsByTagName("canvas");
  var img    = canvas[0].toDataURL("image/png");
  var img2    = canvas[0].toDataURL("data:application/octet-stream");
  var apple = document.getElementById("download");
  apple.href = img2;
  
}


//Строй График
function redrawAll() {
    $("#graphingCard").attr("class","w3-card-4 w3-display-topmiddle w3-white w3-border w3-border-blue w3-round-xlarge");
    $("#progressContainer").hide();
    $("#mynetwork").show();
    // create a network
    var container = document.getElementById('mynetwork');    
    data_set.add(cur_graph.nodes);
    var data = {
      nodes: data_set,
      edges: cur_graph.edges
    };

    network = new vis.Network(container, data, options);
    network.on("stabilized", function (params) { $("#freezeGraph").hide();});
    network.on("startStabilizing", function (params) { $("#freezeGraph").show();});
    network.on("selectNode", function (params) {        
        insertNodeInfo(params);
        var parent = params.nodes[0];
        var selected = network.getConnectedNodes(parent);
        selected.push(parent)
        hide_unhide_selected(so.complement(data_set.getIds(), selected),true)
        network.stopSimulation()
    });
    network.on("dragEnd", function (params) {
      network.stopSimulation()});
    network.on("deselectNode", function (params) {
        $("#nodeInfo").hide();
        var parent = params.nodes[0];
        var selected = network.getConnectedNodes(parent);
        selected.push(parent)
        hide_unhide_selected(data_set.getIds(),false)
        network.stopSimulation()
    });
  }

</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-86997959-1', 'auto');
  ga('send', 'pageview');
</script>

</html> 



