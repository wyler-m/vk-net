<!DOCTYPE html>
<html>
 <head>
     <title>VK Visualizer</title>
     <link rel="stylesheet" href="vis.css">
     <meta charset="utf-8">
     <!-- // <script src="https://d3js.org/d3.v4.min.js"></script> -->
     <script src="setOps.js"></script>
    <script src="test_wyler.js"></script>
     <!-- // <script src="test_data.js"></script> -->
     <!-- // <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.16.1/vis.min.js"></script> -->
     <script type="text/javascript" src="vis.js"></script>
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
     <!-- // <script type="text/javascript" src="jLouvain.js"></script> -->

 </head>
 
<body>
    
	   
<div id="container" >
<menu id="controls">

<h1 id="logo"><img src= "vk.svg"> visualizer</h1>
<div id = "controlDiv" >
  <p id="welcome">Enter An ID number and find out what your graph looks like:</p>
  <a id="loginP" href="https://oauth.vk.com/authorize?client_id=4966960&display=page&redirect_uri=https://wyler-m.github.io/vk-net/&scope=friends&response_type=token&v=5.60">If you don't know your number, then login to VK.com</a> </p>
  <input id="vkId" value="16081499"></p>
  <button type="button" onclick="fetchFriendList()">Build Graph</button>
  <!-- <button type="button" onclick="redrawAll()">Build Graph</button> -->
  <button type="button" onclick="freeze_graph()">Freeze Graph</button>
  <button type="button" onclick="change_weights_d()">Node Size: Connections</button>
  <button type="button" onclick="change_weights_p()">Node Size: "linear popularity"</button>
  <button type="button" onclick="change_weights_ap()">Node Size: "relative popularity"</button>
  <button type="button" onclick="test_build()">test build</button>
  <button type="button" onclick="canvas_image()">get image</button>
  <button type="button" onclick="save_build()" >save build</button></br>
  <input type="checkbox" id="showNodesCB">labels</input>

  <p id="testBox"></p>
<progress id= "progbar" max="100" value="0"></progress>
<p id="friendList"></p>

</div>


<div id="nodeInfo" >
  <p id="selectedName">name</p>
  <img id="selectedPic" src = ''>
<p id="selectedImportance">importance</p>
<p id="selectedDegree">0</p>
<p id="idNumber">0</p>
<a id="selectedProfile" target="_blank" class="mylink" href="https">Visit Profile</a></p>
<a id="buildSelected" target="_blank" href="https">Build Graph</a></p>
</div><p>
  </menu>
  <div id="mynetwork" class="wrapper"></div>
  <div id="data" class="wrapper">
<a href="" id="download" target="_blank" download="graph.html">Save Image</a>
  </div>
  </div>
  </body>

  <script>




class graph {
  constructor(){
    this.friends = null;
    this.nodesRetrieved = false;
    this.nodes = [];
    this.edges = [];
    this.weightsDictionary = {
                    "degree":{},
                    "popularity":{},
                    "popularityDeg":{}

                  };
    this.nodeToFriends = {};
    this.unCheckedFriends = null;
    this.currentNode = null;
    this.nodeToInfo = {};  
    this.ownerInfo = {};
    this.first_pass = true;
  }

  init_owner(res){
    this.ownerInfo = res
  }

  init_friends(res){
    this.unCheckedFriends = res["response"];
    this.friends = res["response"].slice(0);
    this.gotoNextNode();
  }

  add_details_array(res_array){
    for (var i = 0; i < res_array.length; i++) {
      this.add_details(res_array[i])
    };
  }

  add_details(res){
    if (res.photo_200 == undefined) {res.photo_200 = "http://vk.com/images/camera_200.png"};
    this.nodes.push( {"id": res.uid, "label": res.first_name + " " + res.last_name, title: "<img src="+ res.photo_200 +" alt="+res.first_name + " " + res.last_name + "><p>" + res.first_name + " " + res.last_name + "</p><p>"+res.city, small_pic:res.photo_100, group:res.city } );
  }

  gotoNextNode(){
    if (this.unCheckedFriends) {
      this.currentNode = this.unCheckedFriends.pop();
      return this.currentNode;
    };
    this.currentNode = null;
  }

  add_new_friends(res){
    this.nodeToFriends[this.currentNode] = res["response"];
    if (res["response"] && this.friends) {        
        var newLinks = so.intersection(this.friends,res["response"]);
        for (var i = newLinks.length - 1; i >= 0; i--) {
            this.make_link(newLinks[i],this.currentNode);          
        };
      };
  };



  make_link(source,target){
    var sum = source + target;
    if (sum in this.weightsDictionary.degree){
      return;
    }
    this.weightsDictionary.degree[sum] = 1;
    this.count_degree(source); 
    this.count_degree(target);
    this.edges.push({"from":source,"to":target});
  }

  count_degree(id){
    if (id in this.weightsDictionary.degree) {
      this.weightsDictionary.degree[id] ++ ;
    } else {this.weightsDictionary.degree[id] = 1};
  }

  get_density(){
        return this.edges.length / this.nodes.length / (this.nodes.length - 1) * 2;
    }

  weight_nodes_popularity(){
    //iterate through edges, to get the "popularity" for each node
    for (var i = 0; i < this.edges.length; i++) {
      this.run_pop_dict(this.edges[i].to, this.edges[i].from);
    };

  }
    
    run_pop_dict(nodeA, nodeB){
      this.add_to_pop_dict(nodeB, this.get_popularity(nodeA, nodeB));
      this.add_to_pop_dict(nodeA, this.get_popularity(nodeB, nodeA));
    }

    get_popularity(source, target){
      var source_friends = (this.nodeToFriends[source] != undefined)  ? this.nodeToFriends[source]: [] ;

      if (target && source_friends) {
        var location = source_friends.indexOf(target); // find location of the node in queue
        var len = source_friends.length; 
        if ((location!=-1) && (len!=0)) {
          return Math.round(1000/(1 + location));
        };
      };
      return 0;
    }

    add_to_pop_dict(source,rank){
      if (source in this.weightsDictionary.popularity) {
        this.weightsDictionary.popularity[source] += rank ;
      } else {
        this.weightsDictionary.popularity[source] = 0
      };
    }

//generate popularity averaged over degree
    weight_nodes_popularity_deg(){
      var nodes = Object.keys(this.weightsDictionary.degree);
      for (var i = 0; i < nodes.length; i++) {
        var deg = this.weightsDictionary.degree[nodes[i]];
        this.weightsDictionary.popularityDeg[nodes[i]] = Math.round(this.weightsDictionary.popularity[nodes[i]]/deg);
      };
    }



    rank_weights(weight_type){
      var ranked_weights = [];
      var nodes = Object.keys(this.weightsDictionary.degree);
      for (var node in this.nodes){
        var uid = this.nodes[node].id
        var weight = this.weightsDictionary[weight_type][uid];
        if (ranked_weights.indexOf(weight) < 0){
          ranked_weights.push(weight);
        }
      }
      return ranked_weights.sort(function(a, b){return a-b});
    }


    weight_nodes_popularity_deg_rank(scale_type,weight_type){
      var dict_name = scale_type+" "+weight_type
      var scaling_function = {"linear":function(rank) {return (rank)},
                              "quad":function(rank) {return Math.pow(rank,2)},
                              "log":function(rank) {return Math.round(Math.log(rank+1)*100)}  
                              }

      var ranked_weights = this.rank_weights(weight_type);
      if (!(dict_name in this.weightsDictionary)) {
        this.weightsDictionary[dict_name] = {}
        var nodes = Object.keys(this.weightsDictionary.degree);
        for (var i = 0; i < nodes.length; i++) {
          var weight = this.weightsDictionary[weight_type][nodes[i]];
          var node_rank = ranked_weights.indexOf(weight);
          this.weightsDictionary[dict_name][nodes[i]] = scaling_function[scale_type](node_rank);
        };
      };
    }
    

    set_weights(weight_type){
      var size = this.nodes.length;
      for (var i = this.nodes.length - 1; i >= 0; i--) {
        var deg = 0    
        if (!(this.nodes[i].small_pic=="https://vk.com/images/deactivated_100.png")){
          deg = this.weightsDictionary[weight_type][this.nodes[i]["id"]];
        }
      this.nodes[i]["value"] = deg ? deg : 0;
      this.nodeToInfo[this.nodes[i].id] = this.nodes[i];
      }
    }
}


var so = setOps;
var network = null;
var access_token = null;
cur_graph = new graph;

$("#nodeInfo").hide();
$("#buildSelected").hide();
$("#loginP").show();


  $("#selectedProfile").click(function(){
    ga_onclick("#selectedProfile","Check Profile");
  });

  $("#buildSelected").click(function(){
    ga_onclick("#selectedProfile","Build Graph");
  });

function ga_onclick(element,action){
      ga( 'send', 'event', {
          'eventCategory': 'link out',
          'eventAction': action,
          'eventLabel': $(element).attr("href")
        }); 
  }

function insertNodeInfo (argument) {
  var nodeInfo = cur_graph.nodeToInfo[argument.nodes[0]];
  if (cur_graph.nodeToFriends[argument.nodes[0]]) {
    var total_friends = cur_graph.nodeToFriends[argument.nodes[0]].length;
  }else {var total_friends = 0
  };
  $("#nodeInfo").toggle();
  $("#controlDiv").toggle();

  $("#selectedName").text(nodeInfo.label);
  $("#selectedPic").attr("src",nodeInfo.small_pic);

  $("#selectedImportance").text("Average Rank: " + nodeInfo.value);
  $("#idNumber").text("ID: " + nodeInfo.id);
  // $("#selectedImportance").text("Average Rank: " + Math.round(1000/(nodeInfo.value+.01)));

  if (nodeInfo.id in cur_graph.weightsDictionary.degree) {
    $("#selectedDegree").text("Connections: " + cur_graph.weightsDictionary.degree[nodeInfo.id]);
  } else {$("#selectedDegree").text("no connections")};
  
  $("#selectedProfile").attr("href","https://www.vk.com/id"+nodeInfo.id);


  if (nodeInfo.id && (nodeInfo.small_pic!="https://vk.com/images/deactivated_100.png")){
    $("#buildSelected").text("Build Graph ("+ total_friends + " friends)");
    $("#buildSelected").attr("href","https://wyler-m.github.io/vk-net#user_id="+nodeInfo.id);
    $("#buildSelected").show();

  } else {$("#buildSelected").hide();};
    
// google analytics
      ga( 'send', 'event', {
          'eventCategory': 'graph interaction',
          'eventAction': 'select node',
          'eventLabel': nodeInfo.id
        }); 

};


var params = parseURLParams();
if (params) {
  for (var param in params) {
     if (param == "user_id") {
        document.getElementById("vkId").value = params.user_id;
        $("#loginP").hide();        
      };
      if (param == "access_token"){
        access_token = params.access_token;
      }
   }; 
};



function parseURLParams() {
    var params = {};
    var args = window.location.href.split('#');
    if (args[1]) {
      var param_array = args[1].split('&');
      for(var i in param_array){
          x = param_array[i].split('=');
          params[x[0]] = x[1];
      }
    };
    return params;
}

function update_progress(friends, unCheckedFriends){

    document.getElementById("friendList").innerHTML = "added "+ (friends.length - unCheckedFriends.length) +" of " + friends.length + " friends";
    document.getElementById("progbar").max = friends.length;
    document.getElementById("progbar").value = (friends.length - unCheckedFriends.length);
}

function freeze_graph(){  
  if (network) {
    network.stopSimulation();
          ga( 'send', 'event', {
          'eventCategory': 'graph interaction',
          'eventAction': 'freeze graph',
          'eventLabel': cur_graph.ownerInfo["id"],
          'eventValue': cur_graph.get_density()
        }); 
  };
}
 
function fetchDetails(id) {
    var script = document.createElement('SCRIPT');
    var y = '';
    if (access_token) {
      y = "&access_token="+access_token;
    };
    script.src = 'https://api.vk.com/method/users.get?uids='.concat(id,y,'&lang=ru&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town,photo_200,status,photo_100&callback=api_FetchDetails');   
    document.getElementsByTagName("head")[0].appendChild(script);
    }

function api_FetchDetails(result) {
    
    if ('error' in result) {
      console.log(result)
    } 
    else {
      if (!cur_graph.first_pass) {
      var res_array = result["response"];
        cur_graph.add_details_array(res_array);
      } 
      else {
      var res = result["response"][0];
        cur_graph.first_pass = false;
        cur_graph.init_owner(res);
        document.getElementById("welcome").innerHTML = res.first_name +" "+res.last_name;
      };
    };    
}

function fetchFriendList(id) {
    if (!id) {
      var x;
      x = document.getElementById("vkId").value;
      fetchDetails(x);
    } else {x = id; cur_graph.currentNode = id;};

    var script = document.createElement('SCRIPT');
    var y = '';
    if (access_token) {
      y = "&access_token="+access_token;
    };
    script.src = 'https://api.vk.com/method/friends.get?uid='.concat(x,y,'&order=hints&callback=api_FetchFriendList');
    
    document.getElementsByTagName("head")[0].appendChild(script);
    }

function api_FetchFriendList(result) {

//if error
    if ("error" in result) { 
        if ((result["error"]["error_code"]==6) && (cur_graph.currentNode != undefined)){
          cur_graph.unCheckedFriends.push(cur_graph.currentNode);
        }
      };
//check to see if there are any friends in friendlist
    if (!cur_graph.friends) { 
      cur_graph.init_friends(result);      
      fetchFriendList(cur_graph.currentNode);
//google analytics to see if graph was started
      ga( 'send', 'event', {
          'eventCategory': 'graph interaction',
          'eventAction': 'started graph build',
          'eventLabel': cur_graph.ownerInfo["id"],
          'eventValue': cur_graph.unCheckedFriends.length
        });  
    } 
//if not, then take intersection of the response and the friends
    else {
      if (!cur_graph.nodesRetrieved) {
        cur_graph.nodesRetrieved = true;
        var nodes = Object.assign([], cur_graph.friends); 
        while (nodes.length>0){
          var node = nodes.splice(0,100);
          fetchDetails(node.join());  
        }
      };
      update_progress(cur_graph.friends,cur_graph.unCheckedFriends);
      // cur_graph.update_progress();
      
// are there new friends and have there been friends added
      
      if (!("error" in result)) {
        cur_graph.add_new_friends(result);
        // fetchDetails(cur_graph.currentNode);
      };
      
//keep recursing until all the unchecked friends are finished
      // if (cur_graph.unCheckedFriends.length != 0) {
      if (cur_graph.currentNode) {
//add this into the fetch frineds list
      var tempfriend = cur_graph.gotoNextNode() 

        // fetchFriendList(cur_graph.gotoNextNode());  
        fetchFriendList(tempfriend);  
        // fetchFriendList(currentNode);  
      } else { 
        cur_graph.weight_nodes_popularity();
        cur_graph.weight_nodes_popularity_deg();
        // cur_graph.weight_nodes_degree()
        cur_graph.set_weights("degree");
        redrawAll(); 
//google analytics to see if anyone started using it
        ga( 'send', 'event', {
            'eventCategory': 'graph interaction',
             'eventAction': 'finished graph build',
             'eventLabel': cur_graph.ownerInfo["id"],
             'eventValue': cur_graph.get_density()
           });  
         return
        };
      };
    };

function change_weights_d(){
  cur_graph.weight_nodes_popularity_deg_rank("log","degree");
  cur_graph.set_weights("log degree");
  
  ga( 'send', 'event', {
          'eventCategory': 'change weight',
          'eventAction': 'degree'
        }); 
  redrawAll()
}

function change_weights_p(){
  cur_graph.weight_nodes_popularity_deg_rank("linear","popularity");
  cur_graph.set_weights("linear popularity");

  for (var i = cur_graph.nodes.length - 1; i >= 0; i--) {
    data_set.update(cur_graph.nodes[i])
  }
    ga( 'send', 'event', {
          'eventCategory': 'change weight',
          'eventAction': 'popularity'
        }); 
  // redrawAll();
}

function change_weights_ap(){
  cur_graph.set_weights("popularityDeg");
      ga( 'send', 'event', {
          'eventCategory': 'change weight',
          'eventAction': 'average popularity'
        }); 
  redrawAll();
  
}

function test_build(){
cur_graph.currentNode = test_data.currentNode  
cur_graph.edges = test_data.edges   
cur_graph.first_pass = test_data.first_pass   
cur_graph.friends = test_data.friends   
cur_graph.nodeToFriends = test_data.nodeToFriends  
cur_graph.nodeToInfo = test_data.nodeToInfo   
cur_graph.nodes = test_data.nodes   
cur_graph.nodesRetrieved = test_data.nodesRetrieved   
cur_graph.ownerInfo = test_data.ownerInfo   
cur_graph.unCheckedFriends = test_data.unCheckedFriends   
cur_graph.weightsDictionary = test_data.weightsDictionary  
redrawAll()

}

function save_build(){
    test_data = {
"currentNode" : cur_graph.currentNode,  
"edges" : cur_graph.edges,   
"first_pass" : cur_graph.first_pass,   
"friends" : cur_graph.friends,   
"nodeToFriends" : cur_graph.nodeToFriends,  
"nodeToInfo" : cur_graph.nodeToInfo,   
"nodes" : cur_graph.nodes,   
"nodesRetrieved" : cur_graph.nodesRetrieved,   
"ownerInfo" : cur_graph.ownerInfo,   
"unCheckedFriends" : cur_graph.unCheckedFriends,   
"weightsDictionary" : cur_graph.weightsDictionary 
}
document.getElementById("data").innerHTML = JSON.stringify(test_data);

}


function canvas_image(){
  var canvas = document.getElementsByTagName("canvas");
  var img    = canvas[0].toDataURL("image/png");
  var img2    = canvas[0].toDataURL("data:application/octet-stream");
  var apple = document.getElementById("download");
  apple.href = img2;
  
}



//build graph
function redrawAll() {

    // create a network
    var container = document.getElementById('mynetwork');
    var data = {
      nodes: cur_graph.nodes,
      // nodes: test_data.nodes,
      edges: cur_graph.edges
      // edges: test_data.links
    };

    var options = {
      nodes: {
        shape: 'dot',
        scaling: {
          min: 5,
          max: 30
        },
        font: {
          size: 0,
          face: 'Tahoma'
        }
      },
      edges: {
        width: 0.15,
        color: {inherit: 'from'},
        smooth: {
          type: 'continuous'
        }
      },
      physics: {
        stabilization: {
          iterations:10
        },
        adaptiveTimestep: true,
        timestep: .9,
        forceAtlas2Based: {
        // barnesHut: {
          // repulsion:{
          gravitationalConstant: -80,
          damping: 0.4,
          springConstant: 25,
          springLength: 2500,
        }
      },

      interaction: {
        tooltipDelay: 10,
        hideEdgesOnDrag: true
      }
    };

    network = new vis.Network(container, data, options);


    network.on("selectNode", function (params) {        
        insertNodeInfo(params);
    });

    network.on("deselectNode", function (params) {
        $("#nodeInfo").hide();
        $("#controlDiv").show();
    });
  }


//https://api.vk.com/method/friends.get?uid=47617807&order=hints&access_token=cfbe0fe419001f72bd87116a7d0daddff97e99a3943fbc29fcca4457fb33b91e8aaf05b6c4e55f5230c50
// https://wyler-m.github.io/vk-net/#access_token=404fa1c22ba9ba03d1b0f23912316fb7032d1090b648165672555b8cf174bd3fe9249c924cbe8ffc0662a&expires_in=86400&user_id=218868103
//script.src = "https://api.vk.com/method/getProfiles?uid=355065657&callback=callbackFunc";
//script.src = 'https://api.vk.com/method/friends.get?uid=218868103&order=hints&callback=callbackFunc';
//script.src = 'https://api.vk.com/method/users.get?uids=2131567&lang=en&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town&callback=callbackFunc'


// http://visjs.org/examples/network/exampleApplications/worldCupPerformance.html
// http://www.almende.com/contact

// var url = 'https://api.vk.com/method/users.get?uids='.concat(window.urlParams.user_id,'&lang=en&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town,photo_200&callback=api_FetchDetails').concat(window.urlParams.access_token);
// https://api.vk.com/method/users.get?uids=1216918&lang=en&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town,photo_200&callback=api_FetchDetails
// https://api.vk.com/method/users.get?uids=1216918,16081499,218868103&lang=ru&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town,photo_200,status,photo_100&callback=api_FetchDetails
// 1216918
// 16081499
// 218868103

//https://oauth.vk.com/authorize?client_id=4966960&display=page&redirect_uri=https://wyler-m.github.io/vk-net/&scope=friends&response_type=token&v=5.60

// https://api.vk.com/method/friends.get?uid=218868103&v=58&order=hints&lang=ru&fields=first_name,last_name,city,domain,country,universities,schools,sex,bdate,home_town,photo_200,status,photo_100&callback=callbackFunc

</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-86997959-1', 'auto');
  ga('send', 'pageview');
</script>

</html> 



