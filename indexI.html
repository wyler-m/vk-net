<!DOCTYPE html>
<html>
 <head>
     <link rel="stylesheet" href="vis.css">
     <meta charset="utf-8">
     <script src="https://d3js.org/d3.v4.min.js"></script>
     <script src="setOps.js"></script>
     <script src="test_data.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.16.1/vis.min.js"></script>
     <script type="text/javascript" src="jLouvain.js"></script>

 </head>
 
<body>
    
	   
<div id="container">
    <menu id="controls">
        <div class="column">
        <h1><img src= "file:////Users/rmetge/pypro/javascript projects/vk-net/vk.svg"> visualizer</h1>
     <p>Enter An ID number and find out what your graph looks like</p>
      <input id="vkId" value="218868101">
      <button type="button" onclick="fetchFriendList()">Build Graph!</button>
      <p id="testBox"></p>
      <progress id= "progbar" max="100" value="0"></progress>
      <p id="friendList">Friend List</p>
      <!-- <p id="response">if your graph is won't stop bouncing around: </p> -->
      <button type="button" onclick="test_button()">Freeze Graph</button><p>
      <button type="button" onclick="change_weights()">change weights</button><p>
      
  </menu>
  <div id="mynetwork" class="wrapper"></div>
  


  </body>
  

  <script>
// https://wyler-m.github.io/vk-net/#access_token=404fa1c22ba9ba03d1b0f23912316fb7032d1090b648165672555b8cf174bd3fe9249c924cbe8ffc0662a&expires_in=86400&user_id=218868103
//script.src = "https://api.vk.com/method/getProfiles?uid=218868103&callback=callbackFunc";
//script.src = 'https://api.vk.com/method/friends.get?uid=218868103&callback=callbackFunc';
//script.src = 'https://api.vk.com/method/users.get?uids=218868103&lang=en&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town&callback=callbackFunc'

// http://visjs.org/examples/network/exampleApplications/worldCupPerformance.html
// http://www.almende.com/contact

var so = setOps;
var network = null;
// friends = null;
// nodes = [];
// edges = [];
// checkedDictionary = {};
// unCheckedFriends = null;
// currentNode = null;
// logged_in = false;

class graph {
  constructor(){
    this.friends = null;
    this.nodes = [];
    this.edges = [];
    this.checkedDictionary = {};
    this.NodeToFriends = {};
    this.unCheckedFriends = null;
    this.currentNode = null;  
  }

  add_details(res){
    this.nodes.push( {"id": res.uid, "label": res.first_name + " " + res.last_name, title: "<img src="+ res.photo_200 +" alt="+res.first_name + " " + res.last_name + "><p>" + res.first_name + " " + res.last_name + "</p><p>" +  res.uid  +"</p>"} );
  }

  init_friends(res){
    this.unCheckedFriends = res["response"];
    this.friends = res["response"].slice(0);
    this.gotoNextNode();
  }

  gotoNextNode(){
    if (this.unCheckedFriends) {
      this.currentNode = this.unCheckedFriends.pop();
      return this.currentNode;
    };
    this.currentNode = null;
  }

  add_new_friends(res){
    if (res["response"] && this.friends) {        
        var newLinks = so.intersection(this.friends,res["response"]);
        for (var i = newLinks.length - 1; i >= 0; i--) {
            this.make_link(newLinks[i],this.currentNode);          
        };
      };
  }

  make_link(source,target){
    var sum = source + target;
    if (sum in this.checkedDictionary){
      return;
    }
    this.checkedDictionary[sum] = 1;
    this.count_degree(source); 
    this.count_degree(target);
    this.edges.push({"from":source,"to":target});
  }

  count_degree(id){
    if (id in this.checkedDictionary) {
      this.checkedDictionary[id] ++ ;
    } else {this.checkedDictionary[id] = 1};
  }

  weight_nodes(){
    for (var i = this.nodes.length - 1; i >= 0; i--) {
      var deg = this.checkedDictionary[this.nodes[i].id]
      this.nodes[i]["value"] = deg ? deg : 0;
      };
    }
}


cur_graph = new graph;
// cur_graph.friends = 5;
console.log(cur_graph.friends);

// window.urlParams = parseURLParams();

// console.log(parseURLParams());
// console.log(window.urlParams);
var params = parseURLParams();
if (params) {
  for (var id in params) {
     if (id == "user_id") {
    document.getElementById("vkId").value = params.user_id;
      };
   }; 
};
function parseURLParams() {
    var params = {};
    var args = window.location.href.split('#');
    if (args[1]) {
      var param_array = args[1].split('&');
      for(var i in param_array){
          x = param_array[i].split('=');
          params[x[0]] = x[1];
      }
    };
    return params;
}

// var url = 'https://api.vk.com/method/users.get?uids='.concat(window.urlParams.user_id,'&lang=en&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town,photo_200&callback=api_FetchDetails').concat(window.urlParams.access_token);
// https://api.vk.com/method/users.get?uids=1216918&lang=en&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town,photo_200&callback=api_FetchDetails

// 1216918
// 16081499
// 218868103

function update_progress(friends, unCheckedFriends){
    document.getElementById("friendList").innerHTML = "added "+ (friends.length - unCheckedFriends.length) +" of " + friends.length + " friends";
    document.getElementById("progbar").max = friends.length;
    document.getElementById("progbar").value = (friends.length - unCheckedFriends.length);
}

function test_button(){  
  if (network) {network.stopSimulation();};
}
 
function fetchDetails(id) {
   
    var script = document.createElement('SCRIPT');
    script.src = 'https://api.vk.com/method/users.get?uids='.concat(id,'&lang=ru&fields=first_name,last_name,city,country,universities,schools,sex,bdate,home_town,photo_200&callback=api_FetchDetails');   
    document.getElementsByTagName("head")[0].appendChild(script);
    }

function api_FetchDetails(result) {
    var res = result["response"][0];
    document.getElementById("testBox").innerHTML = res["first_name"] + " " + res["last_name"];
    cur_graph.add_details(res);
}

function fetchFriendList(id) {
    if (!id) {
      var x;
      x = document.getElementById("vkId").value;
      currentNode = document.getElementById("vkId").value;
    } else {x = id; cur_graph.currentNode = id;};

    var script = document.createElement('SCRIPT');
    script.src = 'https://api.vk.com/method/friends.get?uid='.concat(x,'&callback=api_FetchFriendList');
    document.getElementsByTagName("head")[0].appendChild(script);
    }

function api_FetchFriendList(result) {
//check to see if there are any friends in friendlist
    if (!cur_graph.friends) { 
      cur_graph.init_friends(result);      
      fetchFriendList(cur_graph.currentNode);
//google analytics to see if graph was started
      ga( 'send', 'event', {
          'eventCategory': 'graph build',
          'eventAction': 'started graph build'
        });  
    } 
//if not, then take intersection of the response and the friends
    else {
      fetchDetails(cur_graph.currentNode);
      update_progress(cur_graph.friends,cur_graph.unCheckedFriends);
      
// are there new friends and have there been friends added

      cur_graph.add_new_friends(result)
      // if (result["response"] && friends) {        
      //   var newLinks = so.intersection(friends,result["response"]);
      //       console.log("current node",currentNode);
      //       console.log("new links", newLinks);
      //       console.log("unchecked friends",unCheckedFriends);
      //   for (var i = newLinks.length - 1; i >= 0; i--) {
      //       make_link(newLinks[i],currentNode);          
      //   };
      // };
      
//keep recursing until all the unchecked friends are finished
      // if (cur_graph.unCheckedFriends.length != 0) {
      if (cur_graph.currentNode) {
        // currentNode = unCheckedFriends.pop();

        //cur_graph.gotoNextNode() //add this into the fetch frineds list

        fetchFriendList(cur_graph.gotoNextNode());  
        // fetchFriendList(currentNode);  
      } else { 
        cur_graph.weight_nodes();
        // weight_nodes()
        redrawAll(); 
//google analytics to see if anyone started using it
        ga( 'send', 'event', {
            'eventCategory': 'graph build',
             'eventAction': 'finished graph build'
           });  
         return
      };
    }
}

//mark edges, and make sure there aren't any repeats
// function make_link(source,target){
//   var sum = source + target;
//   if (sum in checkedDictionary){
//     return;
//   }
//   checkedDictionary[sum] = 1;
//   count_degree(source); 
//   count_degree(target);

//   edges.push({"from":source,"to":target});
// }

// function count_degree(id){
//   if (id in checkedDictionary) {
//     checkedDictionary[id] ++ ;
//   } else {checkedDictionary[id] = 1};
// }

// //rebuild node dicitonary as array
// function weight_nodes()
// {
//   for (var i = nodes.length - 1; i >= 0; i--) {
//     var deg = checkedDictionary[nodes[i].id]
//     nodes[i]["value"] = deg ? deg : 0;
//   };
//     return nodes;
// }

// function change_weights(){

//   for (var i = nodes.length - 1; i >= 0; i--) {
//     console.log(nodes[i].value);
//     console.log(nodes[i].id);
//     nodes[i].value = 10/(nodes[i].value+.1);
//     if (!nodes[i].value) {nodes[i].value = 0};

//   };
// redrawAll();
// }

//build graph
function redrawAll() {

    // create a network
    var container = document.getElementById('mynetwork');
    var data = {
      nodes: cur_graph.nodes,
      // nodes: test_data.nodes,
      edges: cur_graph.edges
      // edges: test_data.links
    };

    var options = {
      nodes: {
        shape: 'dot',
        scaling: {
          min: 5,
          max: 20
        },
        font: {
          size: 12,
          face: 'Tahoma'
        }
      },
      edges: {
        width: 0.15,
        color: {inherit: 'from'},
        smooth: {
          type: 'continuous'
        }
      },
      physics: {
        stabilization: true,
        adaptiveTimestep: true,
        timestep: .9,
        forceAtlas2Based: {
        // barnesHut: {
          // repulsion:{
          gravitationalConstant: -80,
          damping: 0.4,
          springConstant: 250,
          springLength: 250,
        }
      },

      interaction: {
        tooltipDelay: 10,
        hideEdgesOnDrag: true
      }
    };

    network = new vis.Network(container, data, options);
  }

</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-86997959-1', 'auto');
  ga('send', 'pageview');
</script>

</html> 
